<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LIQUID GLASS CHESS - MULTIPLAYER ✨</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-blur: 15px;
            --glass-opacity: 0.03;
            --glass-bg: rgba(255, 255, 255, var(--glass-opacity));
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-glow: #00d4ff;
            --danger-glow: #ff0055;
            --dark-bg: #020617;
            --win-bg: rgba(0, 212, 255, 0.95);
            --lose-bg: rgba(255, 0, 85, 0.95);
            --jewel-color: #fff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #bg-canvas {
            position: fixed;
            inset: 0;
            z-index: -1;
            filter: blur(80px);
            opacity: 0.6;
        }

        .container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            width: 95%;
            max-width: 600px;
        }

        #commentary-box {
            width: 100%;
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            padding: 8px 15px;
            font-size: 0.75rem;
            font-style: italic;
            color: var(--accent-glow);
            min-height: 40px;
            display: flex;
            align-items: center;
            backdrop-filter: blur(10px);
            margin-bottom: 5px;
            transition: all 0.5s ease;
        }

        .glass-header {
            width: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            padding: 12px 20px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-group { display: flex; flex-direction: column; }
        .title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 2px;
            color: var(--accent-glow);
        }
        .level-tag { font-size: 0.6rem; opacity: 0.6; text-transform: uppercase; }

        .timer-group {
            display: flex;
            gap: 15px;
            font-family: 'Orbitron', sans-serif;
        }
        .timer {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }
        .time-val { font-size: 1rem; font-weight: 700; }
        .time-label { font-size: 0.5rem; opacity: 0.5; }
        .timer.active { color: var(--accent-glow); text-shadow: 0 0 10px var(--accent-glow); }

        #board-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.5);
        }

        #board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 100%;
            height: 100%;
        }

        .square {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .square.light { background: rgba(255, 255, 255, 0.02); }
        .square.dark { background: rgba(0, 0, 0, 0.2); }
        .square.selected { background: rgba(0, 212, 255, 0.15) !important; box-shadow: inset 0 0 15px rgba(0, 212, 255, 0.3); }

        .square.hint::after {
            content: '';
            width: 10px;
            height: 10px;
            background: rgba(0, 212, 255, 0.4);
            border-radius: 50%;
        }

        .square.capture-hint::after {
            content: '';
            position: absolute;
            width: 70%;
            height: 70%;
            border: 2px solid rgba(255, 0, 85, 0.4);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .piece {
            font-size: 2.8rem;
            z-index: 5;
            transition: all 0.25s cubic-bezier(0.19, 1, 0.22, 1);
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5));
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        @media (max-width: 500px) { .piece { font-size: 2rem; } }

        /* Jewellery Themes */
        .piece.white { color: var(--jewel-color); text-shadow: 0 0 12px var(--jewel-color); }
        .piece.black { color: rgba(20, 20, 30, 0.9); filter: drop-shadow(0 0 2px rgba(255,255,255,0.2)); }
        
        .theme-diamond { --jewel-color: #e0f7ff; }
        .theme-gold { --jewel-color: #ffd700; }
        .theme-emerald { --jewel-color: #50ffaf; }

        .controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 100%;
        }

        .btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 10px;
            border-radius: 12px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(var(--glass-blur));
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            background: rgba(255,255,255,0.1);
            border-color: var(--accent-glow);
        }

        .btn.active { border-color: var(--accent-glow); color: var(--accent-glow); background: rgba(0, 212, 255, 0.05); }

        .btn.special {
            background: linear-gradient(45deg, rgba(0, 212, 255, 0.1), rgba(157, 0, 255, 0.1));
            border-color: rgba(157, 0, 255, 0.4);
        }

        #settings-overlay, #help-overlay, #multiplayer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(25px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
        }

        .multi-id-display {
            background: rgba(255,255,255,0.05);
            border: 1px dashed var(--accent-glow);
            padding: 15px;
            font-family: monospace;
            font-size: 1.2rem;
            text-align: center;
            margin: 10px 0;
            border-radius: 8px;
            color: var(--accent-glow);
        }

        .help-content {
            max-width: 600px;
            color: #ccc;
            line-height: 1.6;
        }

        .help-section { margin-bottom: 20px; border-left: 2px solid var(--accent-glow); padding-left: 15px; }
        .help-title { color: white; font-family: 'Orbitron', sans-serif; font-size: 0.9rem; margin-bottom: 10px; }

        .setting-row { margin-bottom: 24px; display: flex; flex-direction: column; gap: 10px; }
        .setting-label { font-size: 0.7rem; opacity: 0.6; font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }

        #result-overlay {
            position: absolute;
            inset: 0;
            z-index: 300;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            padding: 20px;
            animation: fadeIn 0.5s ease-out;
        }

        .win-state { background: var(--win-bg); color: #fff; }
        .lose-state { background: var(--lose-bg); color: #fff; }

        .result-title { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; font-weight: 900; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        input[type="text"] {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            padding: 12px;
            border-radius: 10px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            width: 100%;
            margin-bottom: 10px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="theme-diamond">

    <canvas id="bg-canvas"></canvas>

    <div class="container">
        <div id="commentary-box">
            <span id="comm-text">SYSTEM STANDBY...</span>
        </div>

        <header class="glass-header">
            <div class="title-group">
                <div class="title">NEURAL CHESS</div>
                <div id="level-display" class="level-tag">PV CORE (LVL 1)</div>
            </div>
            <div class="timer-group">
                <div id="timer-w" class="timer">
                    <span class="time-val">10:00</span>
                    <span class="time-label">WHITE</span>
                </div>
                <div id="timer-b" class="timer">
                    <span class="time-val">10:00</span>
                    <span class="time-label">BLACK</span>
                </div>
            </div>
        </header>

        <div id="board-wrapper">
            <div id="board"></div>
            <div id="result-overlay">
                <div class="result-title" id="res-title">VICTORY</div>
                <div class="result-subtitle" id="res-sub">CORE SHUTDOWN SUCCESSFUL</div>
                <button class="btn" style="background: #fff; color: #000; width: 100%; margin-top:20px;" onclick="initGame()">REBOOT INTERFACE</button>
            </div>
        </div>

        <div class="controls">
            <button id="multi-btn" class="btn" onclick="openMultiplayer()">LOBBY</button>
            <button class="btn" onclick="openHelp()">HELP</button>
            <button class="btn" onclick="openSettings()">CONFIG</button>
            <button class="btn" onclick="undoMove()">↺</button>
        </div>
        <div class="controls" style="margin-top:-5px">
             <button id="strategy-btn" class="btn special" style="grid-column: span 4" onclick="getStrategySync()">✨ ANALYZE POSITION</button>
        </div>
    </div>

    <!-- Multiplayer Overlay -->
    <div id="multiplayer-overlay" onclick="closeMultiplayer()">
        <div class="settings-panel" onclick="event.stopPropagation()">
            <h2 style="font-family: 'Orbitron', sans-serif; margin-bottom: 15px; color: var(--accent-glow);">MULTIPLAYER CORE</h2>
            <div class="setting-row">
                <label class="setting-label">CREATE LOBBY</label>
                <button class="btn" style="width: 100%;" onclick="createGame()">GENERATE ACCESS CODE</button>
                <div id="game-id-display" class="multi-id-display" style="display:none">---</div>
            </div>
            <div class="setting-row">
                <label class="setting-label">JOIN LOBBY</label>
                <input type="text" id="join-id-input" placeholder="ENTER ACCESS CODE...">
                <button class="btn" style="width: 100%;" onclick="joinGame()">SYNC TO LOBBY</button>
            </div>
            <div class="setting-row" id="multi-status" style="font-size:0.7rem; color: var(--accent-glow); text-align:center;">
                STATIONARY MODE ACTIVE
            </div>
            <button class="btn" style="width: 100%; margin-top: 10px;" onclick="closeMultiplayer()">BACK</button>
        </div>
    </div>

    <!-- Help Overlay -->
    <div id="help-overlay" onclick="closeHelp()">
        <div class="settings-panel help-content" onclick="event.stopPropagation()">
            <h2 style="font-family: 'Orbitron', sans-serif; margin-bottom: 25px; color: var(--accent-glow);">SYSTEM MANUAL</h2>
            <div class="help-section">
                <div class="help-title">MULTIPLAYER SYNC</div>
                <p style="font-size: 0.8rem;">Open the LOBBY menu to generate a code. Share this code with a friend to play in real-time. The game automatically detects your role (White/Black) based on who creates the lobby.</p>
            </div>
            <div class="help-section">
                <div class="help-title">STRATEGY SYNC</div>
                <p style="font-size: 0.8rem;">Use ANALYZE POSITION to send your current FEN state to the Gemini core for tactical advice.</p>
            </div>
            <button class="btn" style="width: 100%; background: var(--accent-glow); color: #000;" onclick="closeHelp()">RETURN TO CORE</button>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settings-overlay" onclick="closeSettings()">
        <div class="settings-panel" onclick="event.stopPropagation()">
            <h2 style="font-family: 'Orbitron', sans-serif; margin-bottom: 25px; font-size: 1.2rem;">SYSTEM CONFIG</h2>
            <div class="setting-row">
                <label class="setting-label">JEWELLERY MATERIAL</label>
                <div class="grid-3">
                    <button class="btn jewel-btn" onclick="setJewellery('diamond')">DIAMOND</button>
                    <button class="btn jewel-btn" onclick="setJewellery('gold')">GOLD</button>
                    <button class="btn jewel-btn" onclick="setJewellery('emerald')">EMERALD</button>
                </div>
            </div>
            <div class="setting-row">
                <label class="setting-label">CORE INTELLIGENCE (SOLO)</label>
                <div class="grid-3">
                    <button class="btn lvl-btn" onclick="setDifficulty(1)">BASIC</button>
                    <button class="btn lvl-btn" onclick="setDifficulty(2)">PRO</button>
                    <button class="btn lvl-btn" onclick="setDifficulty(3)">ELITE</button>
                </div>
            </div>
            <div class="setting-row">
                <label class="setting-label">BACKGROUND ENGINE</label>
                <div class="grid-3">
                    <button class="btn bg-btn" onclick="setBgTemplate('default')">CRYSTAL</button>
                    <button class="btn bg-btn" onclick="setBgTemplate('supernova')">NOVA</button>
                    <button class="btn bg-btn" onclick="setBgTemplate('jewellery')">GLITTER</button>
                </div>
            </div>
            <button class="btn" style="width: 100%; margin-top: 20px; background: var(--accent-glow); color: #000;" onclick="closeSettings()">SAVE & SYNC</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // Firebase Init
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let user = null;
    let currentGameId = null;
    let playerRole = null; // 'w' or 'b'
    let isMultiplayer = false;

    // Standard Game State
    let board = [], selectedSquare = null, turn = 'w', history = [], timers = { w: 600, b: 600 }, timerInterval = null;
    let config = { difficulty: 1, jewellery: 'diamond', bgTemplate: 'default', clock: 10, audio: true };

    const apiKey = ""; 

    async function initAuth() {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    }

    onAuthStateChanged(auth, (u) => {
        user = u;
        if (user) console.log("Core Synced: ", user.uid);
    });

    // Gemini API Bridge
    async function callGemini(prompt, systemPrompt = "You are an advanced chess AI core.") {
        let retries = 5;
        let delay = 1000;
        while (retries > 0) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "...";
            } catch (error) {
                retries--;
                if (retries === 0) return "LINK FAILED.";
                await new Promise(r => setTimeout(r, delay));
                delay *= 2;
            }
        }
    }

    window.getStrategySync = async function() {
        const btn = document.getElementById('strategy-btn');
        const commBox = document.getElementById('comm-text');
        btn.disabled = true;
        btn.innerText = "SYNCING...";
        const fen = getFEN();
        const prompt = `Board: ${fen}. Player is ${turn}. Provide a 2-step tactical plan (max 12 words).`;
        try {
            const strategy = await callGemini(prompt, "You are a tactical grandmaster.");
            commBox.innerText = `✨ TELEMETRY: ${strategy}`;
        } catch (e) {
            commBox.innerText = "TELEMETRY FAILED.";
        } finally {
            btn.disabled = false;
            btn.innerText = "✨ ANALYZE POSITION";
        }
    };

    // Multiplayer Functions
    window.createGame = async function() {
        if (!user) return;
        const gameId = Math.random().toString(36).substring(2, 8).toUpperCase();
        currentGameId = gameId;
        playerRole = 'w';
        isMultiplayer = true;

        const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
        await setDoc(gameRef, {
            board: JSON.stringify(initialBoard()),
            turn: 'w',
            whiteId: user.uid,
            blackId: null,
            lastMove: null,
            status: 'waiting'
        });

        document.getElementById('game-id-display').innerText = gameId;
        document.getElementById('game-id-display').style.display = 'block';
        document.getElementById('multi-status').innerText = "WAITING FOR BLACK...";
        listenToGame(gameId);
    };

    window.joinGame = async function() {
        if (!user) return;
        const gameId = document.getElementById('join-id-input').value.toUpperCase();
        if (!gameId) return;

        const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
        const snap = await getDoc(gameRef);
        if (snap.exists()) {
            currentGameId = gameId;
            playerRole = 'b';
            isMultiplayer = true;
            await updateDoc(gameRef, { blackId: user.uid, status: 'playing' });
            listenToGame(gameId);
            closeMultiplayer();
        } else {
            document.getElementById('multi-status').innerText = "LOBBY NOT FOUND.";
        }
    };

    function listenToGame(id) {
        const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', id);
        onSnapshot(gameRef, (doc) => {
            if (!doc.exists()) return;
            const data = doc.data();
            board = JSON.parse(data.board);
            turn = data.turn;
            if (data.status === 'playing') {
                document.getElementById('multi-status').innerText = "SYNCED: PLAYING";
                if (data.blackId) closeMultiplayer();
            }
            render();
        }, (err) => console.error(err));
    }

    async function syncMoveToFirebase() {
        if (!isMultiplayer || !currentGameId) return;
        const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', currentGameId);
        await updateDoc(gameRef, {
            board: JSON.stringify(board),
            turn: turn
        });
    }

    // Standard Logic
    const PIECES = {
        w: { k: '♔', q: '♕', r: '♖', b: '♗', n: '♘', p: '♙' },
        b: { k: '♚', q: '♛', r: '♜', b: '♝', n: '♞', p: '♟' }
    };

    function initialBoard() {
        return [
            ['br','bn','bb','bq','bk','bb','bn','br'],
            ['bp','bp','bp','bp','bp','bp','bp','bp'],
            [null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],
            ['wp','wp','wp','wp','wp','wp','wp','wp'],
            ['wr','wn','wb','wq','wk','wb','wn','wr']
        ];
    }

    window.initGame = function() {
        board = initialBoard();
        turn = 'w'; selectedSquare = null; history = []; isMultiplayer = false; currentGameId = null;
        timers = { w: config.clock * 60, b: config.clock * 60 };
        document.getElementById('result-overlay').style.display = 'none';
        document.getElementById('multi-status').innerText = "STATIONARY MODE ACTIVE";
        clearInterval(timerInterval); startTimer(); render();
        document.getElementById('comm-text').innerText = "SYSTEM READY.";
    };

    function render() {
        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const sq = document.createElement('div');
                sq.className = `square ${(r + c) % 2 === 0 ? 'light' : 'dark'}`;
                const piece = board[r][c];
                if (piece) {
                    const span = document.createElement('span');
                    span.className = `piece ${piece[0] === 'w' ? 'white' : 'black'}`;
                    span.innerText = PIECES[piece[0]][piece[1]];
                    sq.appendChild(span);
                }
                sq.onclick = () => onSquareClick(r, c);
                boardEl.appendChild(sq);
            }
        }
        updateStatus();
    }

    function onSquareClick(r, c) {
        // In multiplayer, prevent clicking if it's not your turn or your piece
        if (isMultiplayer && turn !== playerRole) return;

        const piece = board[r][c];
        if (selectedSquare) {
            const moves = getValidMoves(selectedSquare.r, selectedSquare.c);
            const move = moves.find(m => m.r === r && m.c === c);
            if (move) { executeMove(selectedSquare.r, selectedSquare.c, r, c); return; }
        }
        if (piece && piece[0] === turn) {
            selectedSquare = { r, c }; highlightSquares(r, c);
        } else {
            selectedSquare = null; clearHighlights();
        }
    }

    function executeMove(fr, fc, tr, tc) {
        history.push(JSON.parse(JSON.stringify(board)));
        const piece = board[fr][fc];
        board[tr][tc] = piece; board[fr][fc] = null;
        if (piece[1] === 'p' && (tr === 0 || tr === 7)) board[tr][tc] = piece[0] + 'q';
        
        selectedSquare = null; turn = turn === 'w' ? 'b' : 'w'; 
        
        if (isMultiplayer) {
            syncMoveToFirebase();
        } else {
            render();
            if (turn === 'b') setTimeout(makeCPUMove, 600);
        }
    }

    function makeCPUMove() {
        let allMoves = [];
        for (let r=0; r<8; r++) for (let c=0; c<8; c++) if (board[r][c] && board[r][c][0] === 'b') {
            getValidMoves(r, c).forEach(m => allMoves.push({ from: {r,c}, to: m }));
        }
        if (allMoves.length === 0) return;
        let chosen = allMoves[Math.floor(Math.random() * allMoves.length)];
        executeMove(chosen.from.r, chosen.from.c, chosen.to.r, chosen.to.c);
    }

    function getValidMoves(r, c) {
        const piece = board[r][c]; if (!piece) return [];
        const moves = [], color = piece[0], type = piece[1];
        const pushIf = (nr, nc) => {
            if (nr<0||nr>7||nc<0||nc>7) return false;
            if (!board[nr][nc]) { moves.push({r:nr, c:nc}); return true; }
            if (board[nr][nc][0] !== color) { moves.push({r:nr, c:nc}); return false; }
            return false;
        };
        if (type === 'p') {
            const d = color === 'w' ? -1 : 1;
            if (!board[r+d]?.[c]) { moves.push({r:r+d, c}); if (((color==='w'&&r===6)||(color==='b'&&r===1)) && !board[r+2*d][c]) moves.push({r:r+2*d, c}); }
            [[-1,1],[1,1]].forEach(o => { if (board[r+d]?.[c+o[0]] && board[r+d][c+o[0]][0] !== color) moves.push({r:r+d, c:c+o[0]}); });
        } else if (type === 'n') [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(o => pushIf(r+o[0], c+o[1]));
        else if (type === 'k') { for(let i=-1;i<=1;i++) for(let j=-1;j<=1;j++) if(i!==0||j!==0) pushIf(r+i, c+j); }
        else if (['r','q'].includes(type)) [[1,0],[-1,0],[0,1],[0,-1]].forEach(d => { for(let i=1;i<8;i++) if(!pushIf(r+d[0]*i, c+d[1]*i)) break; });
        if (['b','q'].includes(type)) [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(d => { for(let i=1;i<8;i++) if(!pushIf(r+d[0]*i, c+d[1]*i)) break; });
        return moves;
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timers[turn]--;
            const f = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
            const tw = document.querySelector('#timer-w .time-val');
            const tb = document.querySelector('#timer-b .time-val');
            if (tw) tw.innerText = f(timers.w);
            if (tb) tb.innerText = f(timers.b);
            document.getElementById('timer-w').classList.toggle('active', turn === 'w');
            document.getElementById('timer-b').classList.toggle('active', turn === 'b');
            if (timers[turn] <= 0) endGame(turn === 'w' ? 'b' : 'w', "OUT OF TIME");
        }, 1000);
    }

    function getFEN() {
        let rows = [];
        for (let r = 0; r < 8; r++) {
            let row = "", empty = 0;
            for (let c = 0; c < 8; c++) {
                const p = board[r][c];
                if (!p) empty++;
                else {
                    if (empty > 0) { row += empty; empty = 0; }
                    row += p[0] === 'w' ? p[1].toUpperCase() : p[1];
                }
            }
            if (empty > 0) row += empty;
            rows.push(row);
        }
        return rows.join('/') + " " + turn;
    }

    function updateStatus() {
        let k = {w:0, b:0}; board.forEach(r => r.forEach(p => { if(p && p[1]==='k') k[p[0]]++; }));
        if (!k.w) endGame('b', 'KING FALLEN'); else if (!k.b) endGame('w', 'ENEMY PURGED');
    }

    function endGame(winner, reason) {
        clearInterval(timerInterval);
        const overlay = document.getElementById('result-overlay');
        overlay.style.display = 'flex';
        overlay.className = winner === 'w' ? 'win-state' : 'lose-state';
        document.getElementById('res-title').innerText = winner === 'w' ? 'VICTORY' : 'DEFEAT';
        document.getElementById('res-sub').innerText = reason;
    }

    function clearHighlights() { document.querySelectorAll('.square').forEach(s => s.classList.remove('selected', 'hint', 'capture-hint')); }
    function highlightSquares(r, c) {
        clearHighlights();
        const sqs = document.querySelectorAll('.square');
        sqs[r*8+c].classList.add('selected');
        getValidMoves(r, c).forEach(m => sqs[m.r*8+m.c].classList.add(board[m.r][m.c] ? 'capture-hint' : 'hint'));
    }

    // UI Helpers
    window.openSettings = () => document.getElementById('settings-overlay').style.display = 'flex';
    window.closeSettings = () => document.getElementById('settings-overlay').style.display = 'none';
    window.openHelp = () => document.getElementById('help-overlay').style.display = 'flex';
    window.closeHelp = () => document.getElementById('help-overlay').style.display = 'none';
    window.openMultiplayer = () => document.getElementById('multiplayer-overlay').style.display = 'flex';
    window.closeMultiplayer = () => document.getElementById('multiplayer-overlay').style.display = 'none';
    
    window.setJewellery = (m) => { config.jewellery = m; document.body.className = `theme-${m}`; };
    window.setDifficulty = (l) => { config.difficulty = l; initGame(); };
    window.undoMove = () => { if (history.length > 0) { board = history.pop(); turn = turn === 'w' ? 'b' : 'w'; render(); } };

    const bgCanvas = document.getElementById('bg-canvas');
    const bgCtx = bgCanvas.getContext('2d');
    function animateBG() {
        bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight;
        bgCtx.fillStyle = '#020617'; bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
        const time = Date.now();
        let palette = ['#00d4ff', '#0078d4', '#4400ff'], speed = 0.0005;
        if(config.bgTemplate === 'supernova') palette = ['#ff0055', '#ffaa00', '#ff00ff'];
        palette.forEach((c, i) => {
            const x = bgCanvas.width/2 + Math.cos(time * speed + i) * (bgCanvas.width/4);
            const y = bgCanvas.height/2 + Math.sin(time * speed * 0.7 + i) * (bgCanvas.height/4);
            bgCtx.fillStyle = c; bgCtx.beginPath(); bgCtx.arc(x, y, 350, 0, Math.PI*2); bgCtx.fill();
        });
        requestAnimationFrame(animateBG);
    }

    // Boot
    initAuth();
    initGame();
    animateBG();
</script>
</body>
</html>